name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - 'epic/**'
      - 'story/**'
  pull_request:
    branches:
      - main
      - 'epic/**'

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate story branch format
        if: startsWith(github.ref, 'refs/heads/story/')
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          
          # Expected format: story/{epic}.{story}-{kebab-case-name}
          # Example: story/9.2-build-contact-form
          
          if [[ ! "$BRANCH" =~ ^story/[0-9]+\.[0-9]+-[a-z0-9-]+$ ]]; then
            echo "❌ Invalid story branch name: $BRANCH"
            echo ""
            echo "Expected format: story/{epic}.{story}-{name}"
            echo ""
            echo "Example: story/1.1-initialize-nextjs"
            exit 1
          fi
          
          echo "✅ Valid story branch name: $BRANCH"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Convex deployment
        run: |
          echo "Configuring Convex for CI/CD..."
          mkdir -p .convex
          echo '{"deployment": "'$CONVEX_DEPLOYMENT'"}' > .convex/deployment.json
          cat .convex/deployment.json
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT }}

      - name: Generate Convex types
        run: |
          echo "Generating Convex types..."
          echo "CONVEX_URL: $CONVEX_URL"
          echo "CONVEX_DEPLOYMENT configured: $(cat .convex/deployment.json)"
          
          # Generate types using configured deployment
          npx convex codegen || {
            echo ""
            echo "❌ Convex codegen failed"
            echo ""
            echo "Configuration:"
            cat .convex/deployment.json || echo "No deployment.json"
            echo ""
            echo "Please verify in GitHub Secrets:"
            echo "  1. CONVEX_DEPLOYMENT = your-deployment-name"
            echo "  2. NEXT_PUBLIC_CONVEX_URL = https://your-deployment.convex.cloud"
            echo ""
            echo "Get these values from your local .env.local file"
            exit 1
          }
          
          echo ""
          echo "✅ Convex types generated successfully"
          echo ""
          echo "Generated files:"
          ls -la convex/_generated/
        env:
          CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}

      - name: TypeScript type check
        run: pnpm exec tsc --noEmit

      - name: ESLint check
        run: pnpm run lint

      - name: Build Next.js
        run: pnpm run build
        env:
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY || 'pk_test_placeholder_for_ci_builds' }}

      - name: Summary
        if: success()
        run: |
          echo "✅ All checks passed!"
          echo "- Branch validation: ✓"
          echo "- Dependencies installed: ✓"
          echo "- Convex types generated: ✓"
          echo "- TypeScript check: ✓"
          echo "- ESLint check: ✓"
          echo "- Next.js build: ✓"

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - 'epic/**'
      - 'story/**'
  pull_request:
    branches:
      - main
      - 'epic/**'

jobs:
  validate-branch:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/story/')
    steps:
      - name: Extract branch name
        id: extract_branch
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
      
      - name: Validate story branch format
        run: |
          BRANCH="${{ steps.extract_branch.outputs.branch }}"
          
          # Expected format: story/{epic}.{story}-{kebab-case-name}
          # Example: story/9.2-build-contact-form
          
          if [[ ! "$BRANCH" =~ ^story/[0-9]+\.[0-9]+-[a-z0-9-]+$ ]]; then
            echo "❌ Invalid story branch name: $BRANCH"
            echo ""
            echo "Expected format: story/{epic}.{story}-{name}"
            echo ""
            echo "Example: story/1.1-initialize-nextjs"
            exit 1
          fi
          
          echo "✅ Valid story branch name: $BRANCH"

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: [validate-branch]
    if: |
      always() && 
      (needs.validate-branch.result == 'success' || needs.validate-branch.result == 'skipped')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Convex types
        run: npx convex codegen
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: TypeScript type check
        run: pnpm exec tsc --noEmit

      - name: ESLint check
        run: pnpm run lint

      - name: Build Next.js
        run: pnpm run build
        env:
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY || 'pk_test_placeholder_for_ci_builds' }}

      - name: Summary
        if: success()
        run: |
          echo "✅ All checks passed!"
          echo "- Branch validation: ✓"
          echo "- Dependencies installed: ✓"
          echo "- Convex types generated: ✓"
          echo "- TypeScript check: ✓"
          echo "- ESLint check: ✓"
          echo "- Next.js build: ✓"

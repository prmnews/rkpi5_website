name: Story Branch Validation

on:
  push:
    branches:
      - 'story/**'

env:
  NODE_VERSION: '20.x'

jobs:
  # Validate story branch follows naming convention
  validate-branch:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    
    steps:
      - name: Check branch name format
        run: |
          BRANCH="${{ github.ref_name }}"
          if [[ ! $BRANCH =~ ^story/[0-9]+\.[0-9]+-[a-z0-9-]+$ ]]; then
            echo "âŒ Invalid story branch name: $BRANCH"
            echo "Expected format: story/{epic}.{story}-{name}"
            echo "Example: story/1.1-initialize-nextjs"
            exit 1
          fi
          echo "âœ… Valid story branch name: $BRANCH"

  # Run quick validation checks
  quick-check:
    name: Quick Validation
    runs-on: ubuntu-latest
    needs: validate-branch
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint check
        run: npm run lint
      
      - name: Type check
        run: npx tsc --noEmit
      
      - name: Build check
        run: npm run build
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: 'pk_test_placeholder'
          NEXT_PUBLIC_CONVEX_URL: 'https://placeholder.convex.cloud'
          NEXT_PUBLIC_SITE_URL: 'https://localhost:3000'

  # Check for merge conflicts with target epic branch
  check-conflicts:
    name: Check for Merge Conflicts
    runs-on: ubuntu-latest
    needs: validate-branch
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract epic branch from story branch
        id: epic
        run: |
          STORY_BRANCH="${{ github.ref_name }}"
          EPIC_NUMBER=$(echo $STORY_BRANCH | sed 's/story\/\([0-9]*\)\..*/\1/')
          EPIC_BRANCH="epic/${EPIC_NUMBER}-$(git branch -r | grep "origin/epic/${EPIC_NUMBER}-" | sed 's/.*epic\/[0-9]*-//' | head -1)"
          echo "epic_branch=$EPIC_BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Target epic branch: $EPIC_BRANCH"
      
      - name: Check for merge conflicts
        run: |
          git fetch origin
          EPIC_BRANCH="${{ steps.epic.outputs.epic_branch }}"
          if git merge-tree $(git merge-base HEAD origin/$EPIC_BRANCH) HEAD origin/$EPIC_BRANCH | grep -q "^+<<<<<<< "; then
            echo "âš ï¸ Merge conflicts detected with $EPIC_BRANCH"
            echo "Please resolve conflicts before merging"
            exit 1
          else
            echo "âœ… No merge conflicts with $EPIC_BRANCH"
          fi

  # Provide merge instructions
  merge-instructions:
    name: Provide Merge Instructions
    runs-on: ubuntu-latest
    needs: [quick-check, check-conflicts]
    
    steps:
      - name: Comment on commit
        uses: actions/github-script@v7
        with:
          script: |
            const storyBranch = context.ref.replace('refs/heads/', '');
            const epicNumber = storyBranch.match(/story\/(\d+)\./)[1];
            const epicBranch = `epic/${epicNumber}-*`;
            
            const message = `
            ## âœ… Story Branch Validation Passed
            
            **Story Branch:** \`${storyBranch}\`
            **Target Epic:** \`${epicBranch}\`
            
            ### Next Steps:
            1. Complete all tasks in this story
            2. Test thoroughly
            3. Merge to epic branch:
               \`\`\`bash
               git checkout ${epicBranch}
               git merge ${storyBranch}
               git push origin ${epicBranch}
               \`\`\`
            
            ### When Epic Complete:
            Merge epic to main:
            \`\`\`bash
            git checkout main
            git merge ${epicBranch}
            git push origin main
            \`\`\`
            `;
            
            // This would be better as a PR comment, but works for commits too
            console.log(message);

